---
title: Genus-level ASCI
output: 
  html_document:
    code_folding: hide
self_contained: yes
---

* Summarize traits from selected metrics by genus
* Uses occurrence of species grouped by genus in development (statewide) dataset

```{r, warning = F, message = F}
library(tidyverse)
library(ASCI)

data(taxain)

# add a complete genus column to the traits lookup table
# select only the trait categories used in selected metrics
x <- pmmilkup$traits %>%
  dplyr::select(Phylum, Class, Order, Family, Genus1, FinalIDassigned, everything()) %>% 
  dplyr::select(-orig.FinalID, -AlgaeList) %>% 
  mutate_if(is.factor, as.character) %>% 
  rowwise() %>% 
  mutate(Genus1 = do({
    
    # use genus1 if not empty
    if(Genus1 != '')
      return(Genus1)
    
    chk <- c(Phylum, Class, Order, Family, Genus1)
    
    # get first of FinalIDassigned if all higher taxa cats are empty
    if(all(chk == '')){
      
      out <- strsplit(FinalIDassigned, ' ')[[1]][1]
      
      # get last non-empty cat  
    } else {
      
      out <- chk[chk != ''] %>% rev %>% .[1]
      
    }
    
    return(out)
    
  })
  ) %>% 
  dplyr::select(-Phylum, -Class, -Order, -Family) %>% 
  unique %>% 
  gather('trait', 'est', -Genus1, -FinalIDassigned) %>% 
  rename(FinalID = FinalIDassigned)

# join species level data with genus traits to summarize counts by data dist
to_summ <- taxain %>% 
  left_join(x, by = 'FinalID') %>% 
  mutate(
    Genus1 = ifelse(is.na(Genus1), gsub(' .*$', '', FinalID), Genus1),
    est = ifelse(est %in% '', NA, est)
  )

# summarize trait counts by data dist
traits_gen <- to_summ %>% 
  group_by(Genus1, trait, est) %>% 
  summarise(n = length(est)) %>% 
  group_by(Genus1, trait) %>% 
  mutate(prp = n / sum(n))

print(tbl_df(traits_gen), n = 30)
```

* Traits are assigned to the genus level if more than 75% of species in the genus have a given trait, otherwise NA.  Assignments at higher taxonomic resolution (e.g., family) remain the same.

```{r}
traits_gen <- traits_gen %>% 
  group_by(Genus1, trait) %>% 
  filter(prp > 0.75) %>% 
  ungroup %>% 
  dplyr::select(-prp, -n) %>% 
  spread(trait, est) %>% 
  rename(FinalIDassigned = Genus1)

head(traits_gen)
```

* Indicator species analysis:

```{r, eval = F}
library(tidyverse)
library(indicspecies)

data(taxain)
data(sitcat)

indicators <- pmmilkup$indicators 

# groups for indic
grpin <- sitcat %>% 
  filter(cls %in% c('int', 'rc', 'str')) %>% 
  mutate(
    cls = fct_recode(cls, Intermediate = 'int',  Reference = 'rc', Stressed = 'str'),
    cls = as.character(cls)
    ) %>% 
  dplyr::select(-psa) %>% 
  filter(SampleID %in% taxain$SampleID) %>% 
  spread(SampleID, cls) %>% 
  unlist

# filter taxonomy data by sites in dev dataset, make wide format for indic  
abuin <- taxain %>% 
  dplyr::select(SampleID, FinalID, BAResult, Result) %>% 
  mutate(abund = as.numeric(pmax(BAResult, Result, na.rm = T))) %>% 
  dplyr::select(-BAResult, -Result) %>% 
  group_by(SampleID, FinalID) %>% 
  summarise(abund = sum(abund, na.rm = T)) %>% 
  ungroup %>% 
  mutate(abund = ifelse(is.na(abund), 0, 1)) %>% 
  filter(SampleID %in% names(grpin)) %>% 
  spread(FinalID, abund, fill = 0) %>% 
  data.frame(stringsAsFactors = F) %>% 
  remove_rownames %>% 
  column_to_rownames('SampleID') %>% 
  .[match(rownames(.), names(grpin)), ]

x <- multipatt(abuin, grpin, max.order = 1)

summary(x)

```


